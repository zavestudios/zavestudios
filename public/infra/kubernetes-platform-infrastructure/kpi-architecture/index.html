<!DOCTYPE html>
<html id="R-html" lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.154.5">
    <meta name="generator" content="Relearn 9.0.3+dd4f8457f5143e91eae3954813494d2b0cc6741c">
    <meta name="robots" content="noindex, nofollow, noarchive, noimageindex">
    <meta name="description" content="kubernetes-platform-infrastructure Architecture Production-grade k3s cluster infrastructure with automated deployment and multi-environment portability.
This document covers the complete technical architecture of the kpi infrastructure, including deployment patterns, network topology, authentication flows, and operational procedures.
Overview kubernetes-platform-infrastructure (kpi) provides Infrastructure as Code to deploy a 3-node k3s cluster on KVM/libvirt virtualization. The infrastructure serves as the foundation for the ZaveStudios multi-tenant platform, hosting multiple tenant applications with isolated resources.">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:description" content="kubernetes-platform-infrastructure Architecture Production-grade k3s cluster infrastructure with automated deployment and multi-environment portability.
This document covers the complete technical architecture of the kpi infrastructure, including deployment patterns, network topology, authentication flows, and operational procedures.
Overview kubernetes-platform-infrastructure (kpi) provides Infrastructure as Code to deploy a 3-node k3s cluster on KVM/libvirt virtualization. The infrastructure serves as the foundation for the ZaveStudios multi-tenant platform, hosting multiple tenant applications with isolated resources.">
    <meta property="og:url" content="http://localhost:1313/infra/kubernetes-platform-infrastructure/kpi-architecture/index.html">
    <meta property="og:site_name" content="ZaveStudios">
    <meta property="og:description" content="kubernetes-platform-infrastructure Architecture Production-grade k3s cluster infrastructure with automated deployment and multi-environment portability.
This document covers the complete technical architecture of the kpi infrastructure, including deployment patterns, network topology, authentication flows, and operational procedures.
Overview kubernetes-platform-infrastructure (kpi) provides Infrastructure as Code to deploy a 3-node k3s cluster on KVM/libvirt virtualization. The infrastructure serves as the foundation for the ZaveStudios multi-tenant platform, hosting multiple tenant applications with isolated resources.">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Infrastructure">
    <meta itemprop="description" content="kubernetes-platform-infrastructure Architecture Production-grade k3s cluster infrastructure with automated deployment and multi-environment portability.
This document covers the complete technical architecture of the kpi infrastructure, including deployment patterns, network topology, authentication flows, and operational procedures.
Overview kubernetes-platform-infrastructure (kpi) provides Infrastructure as Code to deploy a 3-node k3s cluster on KVM/libvirt virtualization. The infrastructure serves as the foundation for the ZaveStudios multi-tenant platform, hosting multiple tenant applications with isolated resources.">
    <meta itemprop="wordCount" content="1768">
    <title></title>
    <link href="/images/logo.png?1770157528" rel="icon" type="image/png">
    <link href="/css/auto-complete/auto-complete.min.css?1770157528" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1770157528" defer></script>
    <script src="/js/search-lunr.js?1770157528" defer></script>
    <script src="/js/search.js?1770157528" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1770157528";
    </script>
    <script src="/js/lunr/lunr.min.js?1770157528" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1770157528" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1770157528" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1770157528" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/all.min.css?1770157528" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/all.min.css?1770157528" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1770157528" rel="stylesheet">
    <link href="/css/theme.css?1770157528" rel="stylesheet">
    <link href="/css/format-html.css?1770157528" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = ``;
      window.relearn.path='\/infra\/kubernetes-platform-infrastructure\/kpi-architecture\/index.html';
      window.relearn.relBasePath='..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..';
      window.relearn.absBaseUri='http:\/\/localhost:1313';
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // translations
      window.T_Copy_to_clipboard = `Copy text to clipboard`;
      window.T_Copied_to_clipboard = `Text copied to clipboard!`;
      window.T_Link_copied_to_clipboard = `Link copied to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      window.T_Browser_unsupported_feature = `This browser doesn't support this feature`;
      // variant stuff
      window.relearn.themevariants = [ 'auto' ];
      window.relearn.customvariantprefix = "my-custom-";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.localStorage.setItem(window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.localStorage.getItem(window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.localStorage.getItem(window.relearn.absBaseUri + "/variant") ?? "";
        if( !variant ||
            (!variant.startsWith(window.relearn.customvariantprefix) && !window.relearn.themevariants.includes(variant)) ||
            (variant.startsWith(window.relearn.customvariantprefix) && !window.localStorage.getItem(window.relearn.absBaseUri + "/variantstylesheet-" + variant)) ){
          variant = window.relearn.themevariants[0];
          window.localStorage.setItem(window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script>
  </head>
  <body class="mobile-support html" data-origin="/infra/kubernetes-platform-infrastructure/kpi-architecture/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar" class="default-animation">
        <div class="topbar-wrapper default-animation">
          <div class="topbar-sidebar-divider default-animation"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar default-animation" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide">
<span class="btn cstyle button link noborder notitle interactive"><button onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button></span>
            </div>
            <div class="topbar-button topbar-button-toc default-animation" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle button link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-table-list"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#cluster-architecture">Cluster Architecture</a>
      <ul>
        <li><a href="#node-topology">Node Topology</a></li>
        <li><a href="#network-architecture">Network Architecture</a></li>
        <li><a href="#storage-architecture">Storage Architecture</a></li>
      </ul>
    </li>
    <li><a href="#deployment-architecture">Deployment Architecture</a>
      <ul>
        <li><a href="#infrastructure-stack">Infrastructure Stack</a></li>
        <li><a href="#deployment-workflow">Deployment Workflow</a></li>
        <li><a href="#key-design-decisions">Key Design Decisions</a></li>
      </ul>
    </li>
    <li><a href="#connection-architecture">Connection Architecture</a>
      <ul>
        <li><a href="#management-connections">Management Connections</a></li>
        <li><a href="#cluster-internal-connections">Cluster Internal Connections</a></li>
        <li><a href="#authentication-summary">Authentication Summary</a></li>
      </ul>
    </li>
    <li><a href="#hypervisor-configuration">Hypervisor Configuration</a>
      <ul>
        <li><a href="#prerequisites">Prerequisites</a></li>
        <li><a href="#initial-setup">Initial Setup</a></li>
        <li><a href="#remote-access-testing">Remote Access Testing</a></li>
      </ul>
    </li>
    <li><a href="#operational-procedures">Operational Procedures</a>
      <ul>
        <li><a href="#standard-operations">Standard Operations</a></li>
        <li><a href="#troubleshooting">Troubleshooting</a></li>
        <li><a href="#maintenance">Maintenance</a></li>
      </ul>
    </li>
    <li><a href="#multi-environment-strategy">Multi-Environment Strategy</a>
      <ul>
        <li><a href="#sandbox-environment-current">Sandbox Environment (Current)</a></li>
        <li><a href="#aws-environment-future">AWS Environment (Future)</a></li>
      </ul>
    </li>
    <li><a href="#security-considerations">Security Considerations</a>
      <ul>
        <li><a href="#ssh-key-management">SSH Key Management</a></li>
        <li><a href="#vm-security">VM Security</a></li>
        <li><a href="#cluster-security">Cluster Security</a></li>
      </ul>
    </li>
    <li><a href="#file-structure-reference">File Structure Reference</a></li>
    <li><a href="#related-documentation">Related Documentation</a></li>
  </ul>
</nav>
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/index.html"><span itemprop="name">ZaveStudios</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/infra/index.html"><span itemprop="name">Infrastructure</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-prev default-animation" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle button link noborder notitle interactive"><a href="/infra/index.html" title="Infrastructure (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span>
            </div>
            <div class="topbar-button topbar-button-next default-animation" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle button link noborder notitle interactive"><a href="/tenants/index.html" title="Tenants (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span>
            </div>
            <div class="topbar-button topbar-button-more default-animation" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle button link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable infra" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id=""></h1>

<h1 id="kubernetes-platform-infrastructure-architecture">kubernetes-platform-infrastructure Architecture<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h1>
<p><strong>Production-grade k3s cluster infrastructure with automated deployment and multi-environment portability.</strong></p>
<p>This document covers the complete technical architecture of the kpi infrastructure, including deployment patterns, network topology, authentication flows, and operational procedures.</p>
<hr>
<h2 id="overview">Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<p>kubernetes-platform-infrastructure (kpi) provides Infrastructure as Code to deploy a 3-node k3s cluster on KVM/libvirt virtualization. The infrastructure serves as the foundation for the ZaveStudios multi-tenant platform, hosting multiple tenant applications with isolated resources.</p>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li>Automated deployment via Terraform + Packer + cloud-init</li>
<li>~5 minute deployment time from scratch</li>
<li>Static IP networking for stability</li>
<li>Pinned k3s versions for reproducibility</li>
<li>Multi-environment design (sandbox + AWS-ready)</li>
</ul>
<p><strong>Current Deployment: Sandbox Environment</strong></p>
<ul>
<li>Runs on spare compute capacity (ZaveLab hardware)</li>
<li>$0/month operational cost</li>
<li>Production-grade automation and patterns</li>
<li>AWS deployment capability maintained via Terraform</li>
</ul>
<hr>
<h2 id="cluster-architecture">Cluster Architecture<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<h3 id="node-topology">Node Topology<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>3-node cluster composition:</strong></p>
<ul>
<li>1x Control Plane: <code>k3s-cp-01</code> @ 192.168.122.10</li>
<li>2x Worker Nodes: <code>k3s-worker-01</code> @ 192.168.122.11, <code>k3s-worker-02</code> @ 192.168.122.12</li>
</ul>
<p><strong>Node specifications:</strong></p>
<ul>
<li>6 vCPUs per node</li>
<li>10GB RAM per node</li>
<li>80GB disk per node</li>
<li>Ubuntu 24.04 LTS</li>
<li>containerd runtime</li>
<li>k3s version: v1.34.3+k3s1 (pinned)</li>
</ul>
<h3 id="network-architecture">Network Architecture<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Physical Topology:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0"><code>Home/Office Network (192.168.1.0/24)
    â”œâ”€ Router (192.168.1.1) - Gateway &amp; DHCP
    â”œâ”€ Laptop (192.168.1.x) - Management station
    â””â”€ Hypervisor Host (192.168.1.y) - KVM/libvirt host
        â””â”€ br0 (bridge to physical NIC)
            â””â”€ libvirt &#34;default&#34; network (192.168.122.0/24)
                â”œâ”€ k3s-cp-01 (192.168.122.10) - static IP
                â”œâ”€ k3s-worker-01 (192.168.122.11) - static IP
                â””â”€ k3s-worker-02 (192.168.122.12) - static IP</code></pre></div>
<p><strong>Network configuration:</strong></p>
<ul>
<li>VMs use libvirt &ldquo;default&rdquo; network (192.168.122.0/24)</li>
<li>Static IPs assigned via cloud-init network_config (not DHCP)</li>
<li>Gateway: 192.168.122.1</li>
<li>DNS: 8.8.8.8, 1.1.1.1</li>
<li>k3s CNI: flannel (VXLAN overlay on port 8472/UDP)</li>
</ul>
<p><strong>Why static IPs:</strong>
DHCP with MAC reservations introduced instability - occasional lease failures or IP changes. Static IPs via cloud-init eliminate this entire class of problems. IP addresses are assigned before any services start, with no lease negotiation or timing dependencies.</p>
<h3 id="storage-architecture">Storage Architecture<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Base image storage:</strong></p>
<ul>
<li>Location: <code>/home/&lt;user&gt;/libvirt_images/</code> on hypervisor host</li>
<li>Pool name: <code>libvirt_images</code> (libvirt storage pool)</li>
<li>Base image: <code>k3s-node-ubuntu-24.04.qcow2</code> (built by Packer)</li>
<li>VM disks: CoW clones of base image (thin provisioned)</li>
</ul>
<p><strong>Cluster storage:</strong></p>
<ul>
<li>Local path provisioner (included with k3s)</li>
<li>Dynamic PV provisioning on each node</li>
<li>Future: NFS for shared storage across nodes</li>
</ul>
<hr>
<h2 id="deployment-architecture">Deployment Architecture<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<h3 id="infrastructure-stack">Infrastructure Stack<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Layer 1: Base Image (Packer)</strong></p>
<ul>
<li>Ubuntu 24.04 LTS minimal server</li>
<li>cloud-init pre-installed and configured</li>
<li>Hypervisor tools (qemu-guest-agent)</li>
<li>Network utilities (curl, wget, ssh)</li>
<li>Clean state (no machine-id, no cloud-init artifacts)</li>
</ul>
<p><strong>Layer 2: VM Provisioning (Terraform + libvirt provider)</strong></p>
<ul>
<li>Provisions 3 VMs from base image</li>
<li>Injects cloud-init user_data and network_config per node</li>
<li>Configures static IPs, hostnames, SSH keys</li>
<li>Connects to libvirt via SSH (remote management from laptop)</li>
</ul>
<p><strong>Layer 3: k3s Installation (cloud-init)</strong></p>
<ul>
<li>Validates network connectivity and DNS before installation</li>
<li>Downloads and installs pinned k3s version (v1.34.3+k3s1)</li>
<li>Control plane: Initializes cluster with <code>k3s server</code></li>
<li>Workers: Join cluster with <code>k3s agent</code> + control plane token</li>
<li>Waits for cluster readiness before marking complete</li>
</ul>
<h3 id="deployment-workflow">Deployment Workflow<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Standard deployment from laptop:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 1. Build base image (one-time, on hypervisor host)</span>
</span></span><span style="display:flex;"><span>cd packer/k3s-node
</span></span><span style="display:flex;"><span>packer build .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. Deploy cluster (from laptop via containerized Terraform)</span>
</span></span><span style="display:flex;"><span>cd terraform-libvirt
</span></span><span style="display:flex;"><span>docker compose run --rm terraform apply
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. Wait ~5 minutes for cloud-init to complete</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. Verify cluster operational</span>
</span></span><span style="display:flex;"><span>ssh ubuntu@192.168.122.10 <span style="color:#e6db74">&#39;sudo k3s kubectl get nodes -o wide&#39;</span></span></span></code></pre></div>
<p><strong>Deployment timeline:</strong></p>
<ul>
<li>VM boot: ~30 seconds per node</li>
<li>cloud-init network validation: ~15 seconds</li>
<li>k3s download and install: ~2-3 minutes</li>
<li>Cluster formation: ~1 minute</li>
<li><strong>Total: ~5 minutes to operational cluster</strong></li>
</ul>
<p><strong>Rebuild workflow:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform destroy  <span style="color:#75715e"># Remove all VMs</span>
</span></span><span style="display:flex;"><span>terraform apply    <span style="color:#75715e"># Recreate identical cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Another 5 minutes, exact same configuration</span></span></span></code></pre></div>
<h3 id="key-design-decisions">Key Design Decisions<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Pinned k3s Version (v1.34.3+k3s1):</strong></p>
<ul>
<li>Decision: Use explicit version, not &ldquo;stable&rdquo; channel</li>
<li>Rationale: Reproducible deployments, controlled upgrades, easier troubleshooting</li>
<li>Trade-off: Manual version updates vs automatic latest</li>
</ul>
<p><strong>Network Validation Before k3s Install:</strong></p>
<ul>
<li>Decision: Validate network interface and DNS resolution before k3s installation</li>
<li>Rationale: Prevents timing failures in certificate generation and API server binding</li>
<li>Cost: 10-15 seconds added to deployment time</li>
<li>Implementation: Loop waiting for interface up + DNS working</li>
</ul>
<p><strong>Clean Base Images:</strong></p>
<ul>
<li>Decision: Remove all machine-specific state from Packer images</li>
<li>Rationale: Prevents MAC address conflicts, cloud-init state issues</li>
<li>Implementation: Cleanup script removes machine-id, cloud-init logs/state, netplan configs</li>
<li>Result: Each VM gets fresh identifiers and clean cloud-init execution</li>
</ul>
<hr>
<h2 id="connection-architecture">Connection Architecture<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<h3 id="management-connections">Management Connections<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Laptop â†’ Hypervisor Host (SSH):</strong></p>
<ul>
<li>Purpose: Terraform libvirt provider connects to hypervisor</li>
<li>Protocol: SSH tunnel (qemu+ssh://)</li>
<li>Authentication: SSH key (~/.ssh/id_rsa)</li>
<li>User: <code>&lt;user&gt;</code></li>
<li>Port: 22</li>
</ul>
<p><strong>Laptop â†’ VMs (SSH):</strong></p>
<ul>
<li>Purpose: Troubleshooting, initial kubeconfig retrieval</li>
<li>Protocol: SSH</li>
<li>Authentication: SSH key (injected by Terraform via cloud-init)</li>
<li>User: ubuntu</li>
<li>Ports: 22</li>
</ul>
<p><strong>Laptop â†’ k3s API (kubectl):</strong></p>
<ul>
<li>Purpose: Normal cluster management</li>
<li>Protocol: HTTPS with mutual TLS</li>
<li>Authentication: kubeconfig with client certificates</li>
<li>Port: 6443</li>
<li>Endpoint: https://192.168.122.10:6443</li>
</ul>
<h3 id="cluster-internal-connections">Cluster Internal Connections<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>k3s control plane â†” worker nodes:</strong></p>
<ul>
<li>6443/TCP: Kubernetes API server</li>
<li>10250/TCP: kubelet API</li>
<li>8472/UDP: flannel VXLAN overlay</li>
<li>Authentication: Node certificates + cluster token</li>
</ul>
<p><strong>Pod-to-pod networking:</strong></p>
<ul>
<li>flannel CNI manages overlay network</li>
<li>VXLAN encapsulation for cross-node traffic</li>
<li>Direct communication within same node</li>
</ul>
<h3 id="authentication-summary">Authentication Summary<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<table>
  <thead>
      <tr>
          <th>Connection</th>
          <th>Protocol</th>
          <th>Auth Method</th>
          <th>User/Entity</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Laptop â†’ Hypervisor</td>
          <td>SSH (port 22)</td>
          <td>SSH key</td>
          <td><code>&lt;user&gt;</code></td>
      </tr>
      <tr>
          <td>Laptop â†’ VMs</td>
          <td>SSH (port 22)</td>
          <td>SSH key</td>
          <td>ubuntu</td>
      </tr>
      <tr>
          <td>Laptop â†’ k3s API</td>
          <td>HTTPS (6443)</td>
          <td>kubeconfig mTLS</td>
          <td>cluster-admin</td>
      </tr>
      <tr>
          <td>Terraform â†’ libvirt</td>
          <td>SSH tunnel</td>
          <td>SSH key</td>
          <td><code>&lt;user&gt;</code></td>
      </tr>
      <tr>
          <td>VMs â†” VMs</td>
          <td>k3s protocols</td>
          <td>k3s certs/tokens</td>
          <td>system:nodes</td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="hypervisor-configuration">Hypervisor Configuration<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<h3 id="prerequisites">Prerequisites<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Hardware (hypervisor host):</strong></p>
<ul>
<li>CPU: 18+ cores recommended</li>
<li>RAM: 32GB minimum (30GB for VMs + 2GB host overhead)</li>
<li>Disk: 250GB+ free space</li>
<li>Network: Ethernet connection to home/office network</li>
</ul>
<p><strong>Software stack:</strong></p>
<ul>
<li>Ubuntu Server 24.04 LTS</li>
<li>QEMU/KVM virtualization</li>
<li>libvirt daemon</li>
<li>Bridge networking (br0)</li>
</ul>
<h3 id="initial-setup">Initial Setup<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Install required packages:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>sudo apt install -y <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    qemu-kvm <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    libvirt-daemon-system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    libvirt-clients <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    bridge-utils <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    openssh-server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enable services</span>
</span></span><span style="display:flex;"><span>sudo systemctl enable libvirtd ssh
</span></span><span style="display:flex;"><span>sudo systemctl start libvirtd ssh</span></span></code></pre></div>
<p><strong>Configure user permissions:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Add user to required groups</span>
</span></span><span style="display:flex;"><span>sudo usermod -aG kvm,libvirt $USER
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Log out and back in for changes to take effect</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Verify membership</span>
</span></span><span style="display:flex;"><span>groups | grep -E <span style="color:#e6db74">&#39;kvm|libvirt&#39;</span></span></span></code></pre></div>
<p><strong>Configure libvirt for remote access:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Edit /etc/libvirt/libvirtd.conf</span>
</span></span><span style="display:flex;"><span>sudo vim /etc/libvirt/libvirtd.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Required settings:</span>
</span></span><span style="display:flex;"><span>listen_tls <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>listen_tcp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>unix_sock_group <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;libvirt&#34;</span>
</span></span><span style="display:flex;"><span>unix_sock_rw_perms <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0770&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Restart libvirtd</span>
</span></span><span style="display:flex;"><span>sudo systemctl restart libvirtd</span></span></code></pre></div>
<p><strong>Create storage pool:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Create storage directory</span>
</span></span><span style="display:flex;"><span>mkdir -p ~/libvirt_images
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Define pool via virsh</span>
</span></span><span style="display:flex;"><span>virsh pool-define-as libvirt_images dir - - - - <span style="color:#e6db74">&#34;</span>$HOME<span style="color:#e6db74">/libvirt_images&#34;</span>
</span></span><span style="display:flex;"><span>virsh pool-build libvirt_images
</span></span><span style="display:flex;"><span>virsh pool-start libvirt_images
</span></span><span style="display:flex;"><span>virsh pool-autostart libvirt_images
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Verify</span>
</span></span><span style="display:flex;"><span>virsh pool-list --all</span></span></code></pre></div>
<h3 id="remote-access-testing">Remote Access Testing<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>From laptop, test libvirt connection:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Test SSH access</span>
</span></span><span style="display:flex;"><span>ssh &lt;user&gt;@&lt;host-ip&gt; <span style="color:#e6db74">&#39;hostname&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Test libvirt via SSH tunnel</span>
</span></span><span style="display:flex;"><span>virsh -c qemu+ssh://&lt;user&gt;@&lt;host-ip&gt;/system list --all
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Should return empty list (no VMs yet)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Test pool access</span>
</span></span><span style="display:flex;"><span>virsh -c qemu+ssh://&lt;user&gt;@&lt;host-ip&gt;/system pool-list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Should show libvirt_images pool</span></span></span></code></pre></div>
<hr>
<h2 id="operational-procedures">Operational Procedures<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<h3 id="standard-operations">Standard Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Deploy cluster:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd terraform-libvirt
</span></span><span style="display:flex;"><span>docker compose run --rm terraform apply
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wait ~5 minutes</span></span></span></code></pre></div>
<p><strong>Access cluster:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Get kubeconfig</span>
</span></span><span style="display:flex;"><span>ssh ubuntu@192.168.122.10 <span style="color:#e6db74">&#39;sudo cat /etc/rancher/k3s/k3s.yaml&#39;</span> &gt; ~/.kube/kpi.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Update server IP</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/127.0.0.1/192.168.122.10/&#39;</span> ~/.kube/kpi.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use kubectl</span>
</span></span><span style="display:flex;"><span>export KUBECONFIG<span style="color:#f92672">=</span>~/.kube/kpi.yaml
</span></span><span style="display:flex;"><span>kubectl get nodes -o wide</span></span></code></pre></div>
<p><strong>Destroy cluster:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd terraform-libvirt
</span></span><span style="display:flex;"><span>docker compose run --rm terraform destroy
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Removes all VMs, keeps base image</span></span></span></code></pre></div>
<p><strong>Rebuild cluster:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform destroy <span style="color:#f92672">&amp;&amp;</span> terraform apply
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Complete cluster recreation in ~5 minutes</span></span></span></code></pre></div>
<h3 id="troubleshooting">Troubleshooting<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>VM won&rsquo;t start:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Check libvirt logs on host</span>
</span></span><span style="display:flex;"><span>ssh &lt;user&gt;@&lt;host-ip&gt; <span style="color:#e6db74">&#39;sudo journalctl -u libvirtd -n 50&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check VM console</span>
</span></span><span style="display:flex;"><span>virsh -c qemu+ssh://&lt;user&gt;@&lt;host-ip&gt;/system console k3s-cp-01</span></span></code></pre></div>
<p><strong>k3s service failed:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># SSH to affected node</span>
</span></span><span style="display:flex;"><span>ssh ubuntu@192.168.122.10
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check k3s status</span>
</span></span><span style="display:flex;"><span>sudo systemctl status k3s
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or for worker:</span>
</span></span><span style="display:flex;"><span>sudo systemctl status k3s-agent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># View logs</span>
</span></span><span style="display:flex;"><span>sudo journalctl -u k3s -f</span></span></code></pre></div>
<p><strong>Network connectivity issues:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Check VM can reach internet</span>
</span></span><span style="display:flex;"><span>ssh ubuntu@192.168.122.10 <span style="color:#e6db74">&#39;ping -c 3 8.8.8.8&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check DNS resolution</span>
</span></span><span style="display:flex;"><span>ssh ubuntu@192.168.122.10 <span style="color:#e6db74">&#39;nslookup google.com&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check k3s pod networking</span>
</span></span><span style="display:flex;"><span>kubectl get pods -A -o wide
</span></span><span style="display:flex;"><span>kubectl logs &lt;pod-name&gt; -n &lt;namespace&gt;</span></span></code></pre></div>
<p><strong>Can&rsquo;t access k3s API:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Verify API server is running</span>
</span></span><span style="display:flex;"><span>ssh ubuntu@192.168.122.10 <span style="color:#e6db74">&#39;sudo systemctl status k3s&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Test API endpoint</span>
</span></span><span style="display:flex;"><span>curl -k https://192.168.122.10:6443/version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check kubeconfig server address</span>
</span></span><span style="display:flex;"><span>grep server: ~/.kube/kpi.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Should be: https://192.168.122.10:6443</span></span></span></code></pre></div>
<h3 id="maintenance">Maintenance<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Update k3s version:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 1. Update version in cloud-init templates</span>
</span></span><span style="display:flex;"><span>vim terraform-libvirt/cloud-init/k3s-cp.yml.tpl
</span></span><span style="display:flex;"><span>vim terraform-libvirt/cloud-init/k3s-worker.yml.tpl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Change: INSTALL_K3S_VERSION=v1.34.3+k3s1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># To: INSTALL_K3S_VERSION=v1.35.0+k3s1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. Destroy and recreate cluster</span>
</span></span><span style="display:flex;"><span>terraform destroy <span style="color:#f92672">&amp;&amp;</span> terraform apply
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. Verify new version</span>
</span></span><span style="display:flex;"><span>kubectl version</span></span></code></pre></div>
<p><strong>Update base image:</strong></p>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 1. On hypervisor host, rebuild Packer image</span>
</span></span><span style="display:flex;"><span>cd ~/kubernetes-platform-infrastructure/packer/k3s-node
</span></span><span style="display:flex;"><span>packer build .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. From laptop, destroy and recreate VMs</span>
</span></span><span style="display:flex;"><span>cd terraform-libvirt
</span></span><span style="display:flex;"><span>terraform destroy <span style="color:#f92672">&amp;&amp;</span> terraform apply
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># VMs now use new base image</span></span></span></code></pre></div>
<hr>
<h2 id="multi-environment-strategy">Multi-Environment Strategy<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<h3 id="sandbox-environment-current">Sandbox Environment (Current)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Infrastructure:</strong></p>
<ul>
<li>Runs on hypervisor host (spare compute capacity)</li>
<li>KVM/libvirt virtualization</li>
<li>Static IPs on local network</li>
<li>No external dependencies</li>
</ul>
<p><strong>Cost:</strong> $0/month</p>
<p><strong>Use cases:</strong></p>
<ul>
<li>Continuous platform development</li>
<li>Tenant application hosting</li>
<li>GitOps testing</li>
<li>Learning and experimentation</li>
</ul>
<h3 id="aws-environment-future">AWS Environment (Future)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Infrastructure:</strong></p>
<ul>
<li>EKS cluster (managed control plane)</li>
<li>EC2 spot instances (worker nodes)</li>
<li>AWS networking (VPC, subnets, load balancers)</li>
<li>Same tenant applications and platform services</li>
</ul>
<p><strong>Cost:</strong> ~$10-20 per weekend deployment</p>
<p><strong>Use cases:</strong></p>
<ul>
<li>Technical demonstrations</li>
<li>Architecture validation</li>
<li>Cloud-native pattern testing</li>
</ul>
<p><strong>Deployment time:</strong> ~20 minutes via Terraform</p>
<p><strong>Portability approach:</strong></p>
<ul>
<li>Application manifests identical in both environments</li>
<li>Environment-specific infrastructure via Kustomize overlays</li>
<li>Same GitOps workflows (Flux + ArgoCD)</li>
<li>Storage classes and load balancer types differ, apps don&rsquo;t</li>
</ul>
<hr>
<h2 id="security-considerations">Security Considerations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<h3 id="ssh-key-management">SSH Key Management<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Single keypair strategy:</strong></p>
<ul>
<li>Private key: <code>~/.ssh/id_rsa</code> (stays on laptop only)</li>
<li>Public key: <code>~/.ssh/id_rsa.pub</code> (distributed to hypervisor host and VMs)</li>
<li>Used for: laptop â†’ hypervisor, laptop â†’ VMs, Terraform â†’ libvirt</li>
</ul>
<p><strong>Never:</strong></p>
<ul>
<li>Copy private key to VMs or hypervisor host</li>
<li>Commit private key to git</li>
<li>Use same key for multiple people</li>
</ul>
<h3 id="vm-security">VM Security<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>Access controls:</strong></p>
<ul>
<li>Only SSH key authentication (no passwords)</li>
<li>Root login disabled</li>
<li>Single user: <code>ubuntu</code> with sudo access</li>
<li>SSH on port 22 only</li>
</ul>
<p><strong>Network isolation:</strong></p>
<ul>
<li>VMs on isolated subnet (192.168.122.0/24)</li>
<li>No direct external access (requires jump through hypervisor host)</li>
<li>Future: Cloudflare Tunnel for external access</li>
</ul>
<h3 id="cluster-security">Cluster Security<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3>
<p><strong>API access:</strong></p>
<ul>
<li>mTLS certificate authentication required</li>
<li>RBAC policies enforced</li>
<li>Default: cluster-admin access via kubeconfig</li>
</ul>
<p><strong>Future hardening:</strong></p>
<ul>
<li>Network policies for pod-to-pod traffic</li>
<li>OPA/Gatekeeper for admission control</li>
<li>Istio service mesh with mTLS</li>
</ul>
<hr>
<h2 id="file-structure-reference">File Structure Reference<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<div class="highlight actionbar-wrapper wrap-code" dir="auto"><pre tabindex="0"><code>kubernetes-platform-infrastructure/
â”œâ”€â”€ terraform-libvirt/
â”‚   â”œâ”€â”€ main.tf                    # VM definitions, cloud-init resources
â”‚   â”œâ”€â”€ variables.tf               # Input variables
â”‚   â”œâ”€â”€ outputs.tf                 # IP addresses, connection info
â”‚   â”œâ”€â”€ terraform.tfvars.example   # Example configuration
â”‚   â”œâ”€â”€ docker-compose.yml         # Containerized Terraform
â”‚   â””â”€â”€ cloud-init/
â”‚       â”œâ”€â”€ k3s-cp.yml.tpl        # Control plane cloud-init
â”‚       â”œâ”€â”€ k3s-worker.yml.tpl    # Worker cloud-init
â”‚       â””â”€â”€ network-config.yml.tpl # Network configuration
â”œâ”€â”€ packer/
â”‚   â””â”€â”€ k3s-node/
â”‚       â”œâ”€â”€ k3s-node.pkr.hcl      # Packer template
â”‚       â”œâ”€â”€ variables.pkr.hcl      # Packer variables
â”‚       â””â”€â”€ scripts/
â”‚           â””â”€â”€ setup.sh           # Provisioning + cleanup
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ cleanup-terraform-state.sh    # Dev: remove from state
â”‚   â””â”€â”€ cleanup-libvirt-resources.sh  # Dev: destroy VMs/volumes
â””â”€â”€ docs/
    â”œâ”€â”€ architecture.md            # This document
    â””â”€â”€ adrs/                      # Architecture decision records</code></pre></div>
<hr>
<h2 id="related-documentation">Related Documentation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type="button" title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2>
<ul>
<li><a href="../README.md">Quick Start Guide</a> - Deployment instructions</li>
<li><a href="/infra/kubernetes-platform-infrastructure/adrs/003-flux-and-argocd-separation/index.html">ADR-003: Flux and ArgoCD Separation</a></li>
<li><a href="/infra/kubernetes-platform-infrastructure/adrs/004-hybrid-sandbox-aws-architecture/index.html">ADR-004: Hybrid Sandbox + AWS Architecture</a></li>
<li><a href="https://github.com/eckslopez/zavestudios" rel="external">ZaveStudios Platform Overview</a></li>
<li><a href="https://docs.k3s.io/" rel="external">k3s Documentation</a></li>
<li><a href="https://registry.terraform.io/providers/dmacvicar/libvirt/latest/docs" rel="external">Terraform Libvirt Provider</a></li>
</ul>
<hr>
<p><strong>Last Updated:</strong> January 28, 2025<br>
<strong>Environment:</strong> Sandbox (hypervisor host)<br>
<strong>k3s Version:</strong> v1.34.3+k3s1<br>
<strong>Cluster Status:</strong> Operational</p>

  <footer class="footline">
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <a id="R-logo" class="R-default direction-row" href="/index.html">
          <span class="logo-title default-animation">ZaveStudios</span>
        </a>
        <search><form action="/search/index.html" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-fw fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-fw fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
      </div>
      <div id="R-homelinks" class="default-animation homelinks">
        <div class="R-menu-divider default-animation">
          <hr class="padding default-animation">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks default-animation">
          <ul class="space collapsible-menu">
            <li class="" data-nav-id="/index.html"><a class="padding" href="/index.html"><i class="fa-fw fas fa-home"></i> Home</a></li>
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding default-animation">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols default-animation">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding default-animation">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main default-animation">
          <ul class="enlarge morespace collapsible-menu">
            <li class="" data-nav-id="/adrs/index.html"><a class="padding default-animation" href="/adrs/index.html">Architecture Decision Records</a><ul id="R-subsections-dbdc3721419d814fe87aa505dc6cf5c9" class="collapsible-menu"></ul></li>
            <li class="" data-nav-id="/ci-cd/index.html"><a class="padding default-animation" href="/ci-cd/index.html">CI/CD</a><ul id="R-subsections-23feba4145c0fd739cb117965ba11416" class="collapsible-menu"></ul></li>
            <li class="" data-nav-id="/experiments/index.html"><a class="padding" href="/experiments/index.html">Experiments</a></li>
            <li class="parent " data-nav-id="/infra/index.html"><a class="padding default-animation" href="/infra/index.html">Infrastructure</a><ul id="R-subsections-99503759600e574ce56874d8fb7763e8" class="collapsible-menu">
            <li class="active hidden " data-nav-id="/infra/kubernetes-platform-infrastructure/kpi-architecture/index.html"><a class="padding" href="/infra/kubernetes-platform-infrastructure/kpi-architecture/index.html"></a></li></ul></li>
            <li class="" data-nav-id="/tenants/index.html"><a class="padding default-animation" href="/tenants/index.html">Tenants</a><ul id="R-subsections-c9e772ccc978a183b81aaafd0378f4ea" class="collapsible-menu"></ul></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts default-animation">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div id="R-footer-margin" class="default-animation"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding default-animation">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols default-animation">
          <ul class="">
          </ul>
        </div>
<div id="R-footer" class="default-animation"><p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p></div>
      </div>
    </aside>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1770157528" defer></script>
    <script src="/js/theme.js?1770157528" defer></script>
    <div id="toast-container" role="status" aria-live="polite" aria-atomic="false"></div>
  </body>
</html>
